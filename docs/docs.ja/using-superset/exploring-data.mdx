---
title: Superset でのデータの探索
hide_title: true
sidebar_position: 2
version: 1
---

import useBaseUrl from "@docusaurus/useBaseUrl";

## Superset でのデータの探索

このチュートリアルでは、2011年に英国を拠点とする組織の従業員が行ったフライトを含む実際のデータセットの調査を通じて、Apache Supersetの主要な概念を紹介します。
各フライトについて、以下の情報が提供されます:

- 旅行者の部門。このチュートリアルでは、部門名をオレンジ、イエロー、パープルに変更しています。
- 航空券の料金。
- 搭乗クラス（エコノミー、プレミアムエコノミー、ビジネス、ファーストクラス）。
- 航空券が片道か往復か。
- 旅行日。
- 出発地と目的地に関する情報。
- 出発地と目的地間の距離（キロメートル単位）。

### データアップロード機能の有効化

CSV または Excel ファイルをデータベースにアップロードする機能を有効にする必要がある場合があります。
次のセクションでは、サンプルデータベースでこの機能を有効にする方法について説明します。

上部のメニューで、 **Settings ‣ Data ‣ Database Connections** を選択します。リストから **examples** データベースを見つけて、**Edit** ボタンを選択します。

<img src={useBaseUrl("/img/tutorial/edit-record.png" )} />

表示されるモーダルウィンドウで、**Advanced** タブに切り替え、 **Security** セクションを開きます。
次に、**Allow file uploads to database** のチェックボックスをオンにします。最後に **Finish** ボタンをクリックします。

<img src={useBaseUrl("/img/tutorial/allow-file-uploads.png" )} />

### CSVデータの読み込み

[GitHub](https://raw.githubusercontent.com/apache-superset/examples-data/master/tutorial_flights.csv) からCSVデータセットをコンピューターにダウンロードします。
上部のメニューで、 **Settings ‣ Data ‣ Database Connections** を選択します。次に、**Upload file to database ‣ Upload CSV** を選択します。

<img src={useBaseUrl("/img/tutorial/upload_a_csv.png" )} />

次に、コンピューターから CSV ファイルを選択し、**Database** と **Schema** を選択して、**Table Name** に _tutorial_flights_ と入力します。

<img src={useBaseUrl("/img/tutorial/csv_to_database_configuration.png" )} />

次に、**File settings ‣ Columns to be parsed as dates** フィールドに「_Travel Date_」というテキストを入力します。

<img src={useBaseUrl("/img/tutorial/parse_dates_column.png" )} />

他のすべてのオプションをデフォルト設定のままにして、ページの下部にある **Upload** を選択します。

### Table の視覚化

**Datasets** タブに、_tutorial_flights_ がデータセットとして表示されます。エントリをクリックすると、このデータセットを使用した Explore ワークフローが起動します。

このセクションでは、フライト数と旅行クラスごとのコストを表示するテーブル ビジュアライゼーションを作成します。

Apache Superset はデフォルトで、過去 1 週間のデータのみを表示します。この例では、データセット内のすべてのデータを視覚化します。**Time ‣ Time Range**  セクションをクリックし、**Range Type** を **No Filter** に変更します。

<img src={useBaseUrl("/img/tutorial/no_filter_on_time_filter.png" )} />

**Apply** をクリックして保存します。

次に、**Group by** オプションを使用して、テーブル内の行を指定します。

この例では、異なる旅行クラスを把握したいため、このメニューで **Travel Class**  を選択します。

次に、**Metrics** オプションを使用して、テーブルに表示する指標を指定します。

- `COUNT(*)` は、テーブル内の行数を表します（この場合は、各旅行クラスのフライト数）。
- `SUM(Cost)` は、各旅行クラスで費やされた合計費用を表します。

<img src={useBaseUrl("/img/tutorial/sum_cost_column.png" )} />

最後に、**Run Query** を選択してテーブルの結果を確認します。

<img src={useBaseUrl("/img/tutorial/tutorial_table.png" )} />

ビジュアライゼーションを保存するには、画面左上の **Save** をクリックします。次のモーダルで、

- **Save as** オプションを選択し、チャート名に「Tutorial Table」と入力します（この名前は、上部メニューの **Charts** 画面で確認できます）。
-  **Add To Dashboard** を選択し、「Tutorial Dashboard」と入力します。最後に、**Save & Go To Dashboard** を選択します。

<img src={useBaseUrl("/img/tutorial/save_tutorial_table.png" )} />

### ダッシュボードの基本

次に、ダッシュボードインターフェースを見ていきましょう。
前のセクションを既に実行している場合は、ダッシュボードがすでに開いているはずです。
そうでない場合は、上部のメニューでダッシュボードを選択し、ダッシュボードのリストから Tutorial dashboard を選択してダッシュボードに移動できます。

このダッシュボードには、前のセクションで作成したテーブルが表示されます。
**Edit dashboard** を選択し、テーブルにマウスを合わせます。
テーブルの右下隅を選択すると（カーソルも変化します）、ドラッグ＆ドロップでサイズを変更できます。

<img src={useBaseUrl("/img/tutorial/resize_tutorial_table_on_dashboard.png" )} />

最後に、右上の「Save changes」を選択して変更を保存します。

### ピボットテーブル

このセクションでは、より複雑な視覚化ツールであるピボットテーブルを使用して分析を拡張します。
このセクションの最後には、最初の6か月間のフライトの月間支出を部門別、旅行クラス別に示す表が作成されます。

右上隅の **+ ‣ Chart** を選択して、新しいチャートを作成します。
データソースとして再度 tutorial_flights を選択し、視覚化の種類をクリックして視覚化メニューを開きます。
 **Pivot Table** 視覚化を選択し（検索ボックスにテキストを入力してフィルタリングできます）、 **Create New Chart** を選択します。

<img src={useBaseUrl("/img/tutorial/create_pivot.png" )} />

**Time** セクションでは、時間列を「旅行日」のままにします（データセットには時間列が1つしかないため、これは自動的に選択されます）。
次に、日次データではパターンを確認するには細かすぎるため、「時間粒度」を「月」に設定します。次に、「時間範囲」セクションで「先週」をクリックして、2011年の最初の6か月間を選択します。次に、「カスタム」で開始日と終了日をそれぞれ2011年1月1日と2011年6月30日に設定します。日付を直接入力するか、カレンダーウィジェットを使用します（月名と年を選択すると、より遠い日付にすばやく移動できます）。

<img src={useBaseUrl("/img/tutorial/select_dates_pivot_table.png" )} />

次に、**Query** セクションで、デフォルトの COUNT(\*) を削除し、デフォルトの SUM 集計をそのままにして Cost を追加します。
Apache Superset では、リストの左側の列の記号でメトリックの種類が示されます（文字列の場合は ABC、数値の場合は #、時間の場合は時計の文字盤など）。

**Group by** で **Time** を選択します。これにより、時間セクションで定義した時間列と時間粒度の選択が自動的に使用されます。

**Columns** で、まず Department を選択し、次に Travel Class を選択します。準備完了です。**Run Query** してデータを確認しましょう。

<img src={useBaseUrl("/img/tutorial/tutorial_pivot_table.png" )} />

行に月、列に部門と旅行クラスが表示されます。
このチャートを、先ほど作成した既存のチュートリアルダッシュボードに公開します。

### 折れ線グラフ

このセクションでは、データセット全体における月ごとのチケットの平均価格を把握するための折れ線グラフを作成します。

Time セクションでは、前述と同様に Time Column を Travel Date、Time Grain を month のままにしますが、今回はデータセット全体を表示するため、Time range には No filter を選択します。

「メトリック」セクションでは、デフォルトの `COUNT(*)` メトリックを削除し、`AVG(Cost)` メトリックを追加して平均値を表示します。

<img src={useBaseUrl("/img/tutorial/average_aggregate_for_cost.png" )} />

次に、**Run Query** を選択して、データをグラフに表示します。

どのように見えるでしょうか？ 12月は平均価格が上昇していることがわかります。ただし、片道チケットと往復チケットをまとめて表示するのは意味がないので、チケットの種類ごとに2つの線を表示した方が良いかもしれません。

「グループ化の基準」ボックスで「片道チケット」または「往復チケット」を選択し、もう一度 **Run Query** を選択して、これを行いましょう。

いいですね！平均すると片道チケットの方が往復チケットよりも安く、12月の急上昇は往復チケットによるものであることがわかります。

グラフはすでにかなり良い出来栄えですが、左側のペインの「カスタマイズ」タブに移動して、さらにカスタマイズしてみましょう。このペインで、配色を変更し、「範囲フィルターの表示」ドロップダウンで「いいえ」を選択して範囲フィルターを削除し、「X軸ラベル」と「Y軸ラベル」を使ってラベルを追加してみましょう。

<img src={useBaseUrl("/img/tutorial/tutorial_line_chart.png" )} />

完了したら、チュートリアルダッシュボードでチャートを公開します。

### マークアップ

このセクションでは、ダッシュボードにテキストを追加します。
すでにダッシュボードにアクセスしている場合は、上部のメニューで「ダッシュボード」を選択し、ダッシュボードのリストから「チュートリアルダッシュボード」を選択してダッシュボードに移動できます。
**Edit dashboard** を選択して編集モードに入ります。

「コンポーネントの挿入」ペインで、Markdown ボックスをダッシュ​​ボードにドラッグ＆ドロップします。
ボックスを配置するアンカーを示す青い線を探してください。

<img src={useBaseUrl("/img/tutorial/blue_bar_insert_component.png" )} />

テキストを編集するには、ボックスを選択します。Markdown形式でテキストを入力できます（この形式の詳細については、[こちらのMarkdownチートシート](https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet)をご覧ください）。ボックス上部のメニューで「編集」と「プレビュー」を切り替えることができます。

<img src={useBaseUrl("/img/tutorial/markdown.png" )} />

終了するには、ダッシュボードの他の部分を選択してください。最後に、**Save changes** をクリックして変更内容を保存することを忘れないでください。

### ダッシュボードを公開する

前のセクションで説明した手順をすべて実行すると、ダッシュボードは以下のようになります。
必要に応じて、**Edit dashboard** を選択してドラッグアンドドロップすることで、ダッシュボードの要素を並べ替えることができます。

ダッシュボードを他のユーザーが利用できるようにしたい場合は、ダッシュボードのタイトルの横にある「下書き」を選択して、ダッシュボードを公開状態にします。
また、星印を選択して、このダッシュボードをお気に入りに追加することもできます。

<img src={useBaseUrl("/img/tutorial/publish_dashboard.png" )} />

### アノテーション

アノテーションを使用すると、グラフにコンテキストを追加できます。
このセクションでは、前のセクションで作成したチュートリアル折れ線グラフにアノテーションを追加します。
具体的には、アイスランドのグリムスヴォトン火山の噴火（2011年5月23日～25日）を受けて、英国民間航空局が一部のフライトをキャンセルした日付を追加します。

まず、「管理」‣「アノテーションレイヤー」に移動してアノテーションレイヤーを追加します。
緑色のプラス記号を選択して新しいレコードを追加し、新しいアノテーションレイヤーを追加します。
「火山噴火」という名前を入力して保存します。
このレイヤーは、さまざまな注釈を参照するために使用できます。

次に、「管理」‣「アノテーション」に移動してアノテーションを追加し、緑色のプラス記号を選択して新しいアノテーションを作成します。
次に、「Volcanic Eruptions」レイヤーを選択し、短い説明「Grímsvötn」と噴火日 (2011 年 5 月 23 ～ 25 日) を追加して、最後に保存します。

<img src={useBaseUrl("/img/tutorial/edit_annotation.png" )} />

次に、「チャート」に移動し、リストから「チュートリアル折れ線グラフ」を選択して、折れ線グラフに移動します。
次に、「アノテーションとレイヤー」セクションに移動し、「アノテーションレイヤーの追加」を選択します。このダイアログで、以下の操作を行います。

- レイヤー名を「Volcanic Eruptions」と入力します。
- アノテーションレイヤーの種類を「イベント」に変更します。
- アノテーションソースを「Superset アノテーション」に設定します。
- アノテーションレイヤーを「Volcanic Eruptions」と指定します。

<img src={useBaseUrl("/img/tutorial/annotation_settings.png" )} />

**Apply** を選択すると、グラフにアノテーションが表示されます。

<img src={useBaseUrl("/img/tutorial/annotation.png" )} />

必要に応じて、「表示設定」セクションで設定を変更することで、注釈の表示方法を変更できます。
変更しない場合は、**OK** を選択し、最後に **Save** を選択してチャートを保存します。デフォルトの選択（チャートを上書きする）のままにしておくと、アノテーションはチャートに保存され、チュートリアルダッシュボードにも自動的に表示されます。

### 高度な分析

このセクションでは、Apache Superset の高度な分析機能について解説します。この機能を使用すると、データに追加の変換を適用できます。変換には以下の 3 種類があります。

**基本チャートの設定**

このセクションでは、さまざまな **高度な分析** 機能を適用できる基本チャートを設定します。
まず、同じ _tutorial_flights_ データソースと **折れ線グラフ** の視覚化タイプを使用して、新しいチャートを作成します。「時間」セクションで、「期間」を 2011 年 10 月 1 日から 2011 年 10 月 31 日に設定します。

次に、「クエリ」セクションで、「指標」を「コストの合計」に変更します。
「クエリを実行」を選択してチャートを表示します。
2011 年 10 月の各月の 1 日あたりの総コストが表示されます。

<img src={useBaseUrl("/img/tutorial/advanced_analytics_base.png" )} />

最後に、視覚化を Tutorial Advanced Analytics Base として保存し、Tutorial Dashboard に追加します。

### ローリング平均

データにはかなり大きなばらつきがあるため、傾向を特定するのは困難です。
時系列の移動平均を表示するという方法があります。
これを行うには、**高度な分析** の **移動平均** サブセクションで、**ローリング** ボックスで平均を選択し、期間と最小期間の両方に 7 を入力します。
期間は、時間粒度の倍数として表されるローリング期間の長さです。
この例では、時間粒度が日なので、ローリング期間は 7 日間となり、2011 年 10 月 7 日に表示される値は 2011 年 10 月の最初の 7 日間に相当します。
最後に、最小期間を 7 に指定することで、平均は常に 7 日間で計算され、増加期間が回避されます。

**クエリを実行** を選択してグラフを表示すると、データの変動が少なくなり、増加期間が除外されるため、系列が遅く開始されていることがわかります。

<img src={useBaseUrl("/img/tutorial/rolling_mean.png" )} />

チャートを「Tutorial Rolling Mean」として保存し、Tutorial ダッシュボードに追加します。

### 時間比較

このセクションでは、時系列の値を1週間前の値と比較します。まず、チュートリアルの高度な分析ベースチャートを開きます。上部メニューの「**チャート**」に移動し、リストからビジュアライゼーション名を選択します（または、チュートリアルダッシュボードでチャートを見つけ、そのビジュアライゼーションのメニューから「チャートの探索」を選択します）。

次に、**高度な分析** の「時間比較」サブセクションで、「マイナス1週間」と入力して時間シフトを入力します（このボックスは自然言語での入力も受け付けます）。
クエリを実行すると、同じ値を持つ追加の系列が1週間前に戻された新しいグラフが表示されます。

<img src={useBaseUrl("/img/tutorial/time_comparison_two_series.png" )} />

次に、**Calculation type** を「絶対差」に変更し、**Run Query** を選択します。
今度は、先ほど表示した2つの系列の差が、再び1つの系列のみに表示されるようになりました。

<img src={useBaseUrl("/img/tutorial/time_comparison_absolute_difference.png" )} />

チャートを「チュートリアル時間比較」として保存し、チュートリアルダッシュボードに追加します。

### データの再サンプリング

このセクションでは、日次データではなく週次データになるようにデータを再サンプリングします。
前のセクションと同様に、チュートリアルの高度な分析ベースチャートを再度開きます。

次に、**Advanced Analytics** の Python 関数サブセクションで、ルールに7日間を表す「7D」を入力し、メソッドに「median」と入力し、**Run Query** を選択してチャートを表示します。

<img src={useBaseUrl("/img/tutorial/resample.png" )} />

これで、7日ごとに1つのデータポイントがあることに注意してください。
この場合、表示されている値は、7つの日次データポイントの中央値に対応しています。
このセクションのさまざまなオプションの意味の詳細については、[Pandasドキュメント](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.resample.html)を参照してください。

最後に、チャートを「Tutorial Resample」という名前で保存し、チュートリアルダッシュボードに追加します。
チュートリアルダッシュボードに移動して、4つのチャートを並べて表示し、異なる出力を比較してください。
