---
title: Docker Builds
hide_title: true
sidebar_position: 6
version: 1
---

# Docker ビルド、イメージ、タグ

Apache Superset コミュニティは、Superset の開発、リリース、および実稼働化に Docker を広く使用しています。
このページでは、ユーザーが当社の製品を理解するのに役立つ Docker ビルドとタグ命名スキームについて詳しく説明します。

イメージは GitHub Actions を使用してビルドされ、[Superset Docker Hub リポジトリ](https://hub.docker.com/r/apache/superset) にプッシュされます。
異なるイメージ セットは、異なるタイミングでビルドおよび/または公開されます:

- **公開されたリリース** (`release`): `3.0.0` や `latest` タグなどのタグを使用して公開されます。
- **プル リクエストの反復** (`pull_request`): 各プル リクエストでは、ビルドを検証するために Docker をアクティブにビルドしますが、セキュリティ上の理由からそれらのイメージを公開せず、単に `docker build --load` を実行します。
- **メイン ブランチにマージ** (`push`): 最新の `master` バージョンを表す `master` というプレフィックスが付いた新しい SHA が生成されます。

## ビルドプリセット

ビルドのパラメータの組み合わせを表すビルド「プリセット」のセットがあり、ほとんどの場合、ビルドの異なるターゲット レイヤーまたはベース イメージのいずれかを指します。

`supersetbot docker` ユーティリティを通じて公開されるビルド プリセットは次のとおりです:

- `lean`: フロントエンドとバックエンドの両方を含むデフォルトの Docker イメージ。
build_preset のないタグは lean ビルドです (つまり、`latest`、`4.0.0`、`3.0.0` など)。
`lean` ビルドにはデータベース ドライバーが含まれていないため、独自のドライバーをインストールする必要があります。
これは、分析データベース ** とメタデータ データベース** に適用されます。
インストール用に選択したメタデータ データベースに応じて、`mysqlclient` または `psycopg2-binary` のいずれかをレイヤー化し、分析データベースに接続するために必要なドライバーを追加すると良いでしょう。
- `dev`: ヘッドレス ブラウザー、開発関連のユーティリティ、およびルート アクセスを備えた開発用。
これには、`mysqlclient`、`psycopg2-binary` などの一般的に使用されるデータベース ドライバーや、開発/CI に使用されるその他のドライバーが含まれます - `py311` (例: Py311): lean に似ていますが、Python のバージョンが異なります (この例では 3.11)。
- `ci`: 特定の CI ワークロード用。
- `websocket`: 高度な機能をサポートするスーパーセット クラスター用。
- `dockerize`: Helm によって使用されます。

## キータグの例

- `latest`: 最新の公式リリース ビルド
- `latest-dev`: 最新の公式リリース ビルドの `-dev` イメージ。ヘッドレス ブラウザーとルート アクセスが含まれます。
- `master`: `master` ブランチの最新ビルド。暗黙的にリーン ビルド プリセットになります
- `master-dev`: `master` に似ていますが、ヘッドレス ブラウザーとルート アクセスが含まれます。
- `pr-5252`: PR 5252 の最新のコミット。
- `30948dc401b40982cb7c0dbf6ebbe443b2748c1b-dev`: この特定の SHA のビルド。
`master` マージまたはリリースからのものである可能性があります。
- `websocket-latest`: スーパーセット クラスターで使用する WebSocket イメージ。

ビルド マトリックスとタグ付け規則の詳細や変更については、[supersetbot docker](https://github.com/apache-superset/supersetbot) サブコマンドと [docker.yml](https://github.com/apache/superset/blob/master/.github/workflows/docker.yml) GitHub アクションを確認してください。

## Dockerfile 内の主要な ARG

- `BUILD_TRANSLATIONS`: 翻訳をイメージに組み込むかどうか。
フロントエンド ビルドの場合、これは webpack に `moment-timezone` ライブラリから `en` 以外のすべてのロケールを削除するように指示します。
バックエンドの場合、これは `*.po` 翻訳ファイルのコンパイルをスキップします
- `DEV_MODE`: フロントエンド ビルドをスキップするかどうか。
これは、ローカル ボリュームをマウントし、`webpack` を `--watch` モードで使用してビルドする `docker-compose` 開発セットアップで使用されます。
つまり、ローカル ファイル システムでコードを変更すると、この目的で使用される docker イメージ内の webpack が、進行中にフロントエンドを継続的に再構築します。
この ARG により、初期の `docker-compose` ビルドにかかる時間とリソースが大幅に削減されます
- `INCLUDE_CHROMIUM`: バックエンド ビルドに Chromium を含めるかどうかを指定します。
これにより、"アラートとレポート" やサムネイル生成に関連するワークロードのヘッドレス ブラウザーとして使用できるようになります
- `INCLUDE_FIREFOX`: 上記と同じですが、Firefox 用です
- `PY_VER`: Python バックエンドのベース イメージを指定します。
前方互換性または後方互換性に取り組んでいない場合は、この設定を変更することはお勧めしません

## キャッシング

ビルドを高速化するために、Docker のベスト プラクティスに従い、`apache/superset-cache` を使用します。

## データベースドライバーについて

各環境では異なるドライバーが必要なため、当社の Docker イメージにはデータベース ドライバーのサポートがほとんどまたはまったくありません。
また、幅広いデータベース サポートを備えたビルドを維持することは困難 (多数のデータベース、Python ドライバー、OS 依存関係) かつ非効率的 (ビルド時間が長く、イメージが大きくなり、レイヤー キャッシュ ヒット率が低くなるなど) です。

本番環境での使用例では、当社の「リーン」イメージを派生させて、必要なデータベースのデータベース サポートを追加することをお勧めします。

## 異なるプラットフォーム（arm64とamd64）のサポートについて

現在、すべての自動ビルドはマルチプラットフォームであり、`linux/arm64` と `linux/amd64` の両方をサポートしています。
これにより、`helm` や `docker compose` などの高レベル構造がこれらのイメージを指し示すことができ、事実上マルチプラットフォームにもなります。

プル リクエストとマスター ビルドはプラットフォームごとに 1 つのイメージであるため、並列化が可能で、すべてのプラットフォームですべてのビルド プリセットをビルドする必要がないため、それらのビルド マトリックスはよりスパースであり、一般的にここでより選択的になります。
これらのビルドでは、該当する場合にタグに `-arm` をサフィックスとして付けます。

### Appleシリコンの活用

Apple の現在の世代のコンピューターは ARM ベースの CPU を使用しており、MAC で実行される Docker には `linux/arm64/v8` が必要であるようです (少なくとも 1 人のユーザーの M2 がそのように構成されていました)。環境変数 `DOCKER_DEFAULT_PLATFORM` を `linux/amd64` に設定すると、ここで提供されているスーパーセット ビルドを活用して構築する点で機能するようです。

```bash
export DOCKER_DEFAULT_PLATFORM=linux/amd64
```

おそらく、`linux/arm64/v8` はこの世代のチップに対してより最適化されますが、ARM エコシステム全体での互換性は低くなります。
